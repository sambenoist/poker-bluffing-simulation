<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Poker Bluffing Strategy Simulation</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
        }
        
        h1 {
            text-align: center;
            color: #00ff88;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        /* Tab Navigation */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
        }
        
        .tab {
            padding: 12px 30px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab:hover {
            color: #00ff88;
        }
        
        .tab.active {
            color: #00ff88;
            border-bottom-color: #00ff88;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Theory Section */
        .theory-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .theory-section h3 {
            color: #ffaa00;
            margin-bottom: 15px;
        }
        
        .formula {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 1.2em;
            color: #00ff88;
            font-family: 'Courier New', monospace;
        }
        
        .theory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .theory-card {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 20px;
        }
        
        .theory-card h4 {
            color: #00ff88;
            margin-bottom: 10px;
        }
        
        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            color: #00ff88;
            margin-bottom: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #00ff88;
            color: #000;
            border-radius: 50%;
            font-size: 12px;
            cursor: help;
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 200px;
            white-space: normal;
        }
        
        .info-icon:hover .tooltip {
            opacity: 1;
        }
        
        input, select, button {
            padding: 10px;
            border: 1px solid #555;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
        }
        
        button {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        small {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }
        
        /* Custom Scenarios */
        .custom-scenarios {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 170, 0, 0.05);
            border-radius: 8px;
            border: 1px solid #ffaa00;
        }
        
        .custom-scenarios h4 {
            color: #ffaa00;
            margin-bottom: 15px;
        }
        
        .scenario-input-group {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
        }
        
        .scenario-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .scenario-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .remove-btn {
            background: #ff4444;
            padding: 5px 10px;
            font-size: 12px;
            margin: 0;
        }
        
        /* Results */
        .results {
            margin-top: 30px;
        }
        
        .scenario {
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 200, 106, 0.05) 100%);
            border-radius: 10px;
            border-left: 5px solid #00ff88;
            position: relative;
        }
        
        .scenario h3 {
            color: #00ff88;
            margin-bottom: 25px;
            font-size: 1.3em;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .metric {
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            border: 1px solid #333;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .metric:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .metric-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .metric-value {
            color: #00ff88;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .breakdown {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .breakdown h4 {
            color: #00ff88;
            margin-bottom: 15px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status.success {
            background: #00ff88;
            color: #000;
        }
        
        .status.warning {
            background: #ffaa00;
            color: #000;
        }
        
        .status.error {
            background: #ff4444;
            color: #fff;
        }
        
        .loading {
            text-align: center;
            color: #00ff88;
            font-size: 1.3em;
            margin: 30px 0;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .summary {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.1) 0%, rgba(255, 136, 0, 0.05) 100%);
            border-radius: 10px;
            border-left: 5px solid #ffaa00;
        }
        
        .summary h3 {
            color: #ffaa00;
            margin-bottom: 20px;
        }
        
        .insights {
            list-style: none;
            padding: 0;
        }
        
        .insights li {
            padding: 10px 0;
            border-bottom: 1px solid #333;
            position: relative;
            padding-left: 25px;
        }
        
        .insights li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #ffaa00;
            font-weight: bold;
        }
        
        .insights li:last-child {
            border-bottom: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                padding: 10px 20px;
                font-size: 1em;
            }
            
            .scenario-input-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎰 Enhanced Poker Bluffing Strategy Simulation</h1>
        <p class="subtitle">
            Explore optimal bluffing frequencies with customizable scenarios, value hand frequencies, and detailed analysis
        </p>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('theory')">📚 Theory</button>
            <button class="tab" onclick="showTab('simulation')">🎲 Simulation</button>
            <button class="tab" onclick="showTab('results')">📊 Results</button>
        </div>
        
        <!-- Theory Tab -->
        <div id="theory" class="tab-content active">
            <div class="theory-section">
                <h3>Understanding Optimal Bluffing Strategy</h3>
                <p>In heads-up river play, the optimal bluffing frequency makes your opponent indifferent between calling and folding. This creates an unexploitable strategy based on game theory.</p>
                
                <div class="formula">
                    Optimal Bluffing Frequency: q = B / (P + B)
                </div>
                
                <div class="theory-grid">
                    <div class="theory-card">
                        <h4>Key Variables</h4>
                        <ul style="list-style: none; padding: 0;">
                            <li>• <strong>P</strong>: Pot size before betting</li>
                            <li>• <strong>B</strong>: Your bet size</li>
                            <li>• <strong>q</strong>: Probability your bet is a bluff</li>
                            <li>• <strong>1-q</strong>: Probability your bet is for value</li>
                        </ul>
                    </div>
                    
                    <div class="theory-card">
                        <h4>Bluff-to-Value Ratio</h4>
                        <div class="formula" style="font-size: 1em;">
                            b/v = B/P
                        </div>
                        <p style="margin-top: 10px;">This ratio ensures your opponent's EV for calling equals their EV for folding (zero).</p>
                    </div>
                    
                    <div class="theory-card">
                        <h4>Example Calculation</h4>
                        <p>Pot = 100, Bet = 50:</p>
                        <ul style="list-style: none; padding: 0; margin-top: 10px;">
                            <li>• Bluffing freq: 50/150 = 33.3%</li>
                            <li>• Bluff-to-value: 50/100 = 1:2</li>
                            <li>• For 12 value bets, bluff 6 times</li>
                        </ul>
                    </div>
                </div>
                
                <div class="theory-section" style="margin-top: 20px; background: rgba(255, 170, 0, 0.05); border: 1px solid #ffaa00;">
                    <h4 style="color: #ffaa00;">💡 Key Insights</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li>• Larger bets relative to pot size require higher bluffing frequencies</li>
                        <li>• Your value hand frequency determines how many weak hands are available for bluffing</li>
                        <li>• Lower value frequencies allow more bluffing flexibility but may reduce overall profitability</li>
                        <li>• Real-world constraints may prevent perfect equilibrium play</li>
                        <li>• Understanding these concepts helps identify exploitable opponents</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Simulation Tab -->
        <div id="simulation" class="tab-content">
            <div class="controls">
                <div class="control-group">
                    <label for="simulations">
                        Number of Simulations
                        <span class="info-icon">?
                            <span class="tooltip">More simulations provide more accurate results but take longer to compute</span>
                        </span>
                    </label>
                    <input type="number" id="simulations" value="100000" min="10000" max="1000000" step="10000">
                    <small>Range: 10,000 - 1,000,000</small>
                </div>
                
                <div class="control-group">
                    <label for="callFreq">
                        Opponent Call Frequency
                        <span class="info-icon">?
                            <span class="tooltip">How often your opponent calls when you bet. Higher values mean a tighter opponent</span>
                        </span>
                    </label>
                    <input type="number" id="callFreq" value="75" min="10" max="100" step="5">
                    <small>Percentage (10-100%)</small>
                </div>
                
                <div class="control-group">
                    <label for="valueFreq">
                        Value Hand Frequency
                        <span class="info-icon">?
                            <span class="tooltip">Percentage of your hands that are strong (value hands). The rest are weak hands that can potentially bluff</span>
                        </span>
                    </label>
                    <input type="number" id="valueFreq" value="50" min="10" max="90" step="5">
                    <small>Percentage (10-90%)</small>
                </div>
                
                <div class="control-group">
                    <label for="scenarios">
                        Scenario Presets
                        <span class="info-icon">?
                            <span class="tooltip">Pre-configured betting patterns or create your own custom scenarios</span>
                        </span>
                    </label>
                    <select id="scenarios">
                        <option value="conservative">Conservative (0.25x - 0.75x pot)</option>
                        <option value="standard">Standard (0.5x - 1.5x pot)</option>
                        <option value="aggressive">Aggressive (1x - 3x pot)</option>
                        <option value="extreme">Extreme (2x - 5x pot)</option>
                        <option value="custom">Custom Scenarios</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <button onclick="runSimulation()" style="width: 100%;">
                        🎲 Run Simulation
                    </button>
                </div>
            </div>
            
            <!-- Custom Scenarios Section -->
            <div id="customScenarios" class="custom-scenarios" style="display: none;">
                <h4>Create Custom Scenarios</h4>
                <div class="scenario-input-group">
                    <div>
                        <label style="font-size: 0.9em;">Pot Size</label>
                        <input type="number" id="customPot" value="100" min="10" max="10000" step="10">
                    </div>
                    <div>
                        <label style="font-size: 0.9em;">Bet Size</label>
                        <input type="number" id="customBet" value="50" min="1" max="10000" step="1">
                    </div>
                    <div>
                        <label style="font-size: 0.9em;">Name</label>
                        <input type="text" id="customName" value="Custom" maxlength="20">
                    </div>
                    <button onclick="addCustomScenario()" style="margin: 0;">Add</button>
                </div>
                <div id="customScenarioList" class="scenario-list"></div>
            </div>
        </div>
        
        <!-- Results Tab -->
        <div id="results-tab" class="tab-content">
            <div id="loading" class="loading" style="display: none;">
                🎲 Running simulations... Please wait
                <span class="loading-spinner"></span>
            </div>
            
            <div id="results" class="results"></div>
        </div>
    </div>

    <script>
        // Global variables for custom scenarios
        let customScenariosList = [];
        
        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            if (tabName === 'results') {
                document.getElementById('results-tab').classList.add('active');
            } else {
                document.getElementById(tabName).classList.add('active');
            }
            
            // Highlight active tab button
            event.target.classList.add('active');
        }
        
        // Show/hide custom controls based on scenario selection
        document.getElementById('scenarios').addEventListener('change', function() {
            const customSection = document.getElementById('customScenarios');
            if (this.value === 'custom') {
                customSection.style.display = 'block';
                if (customScenariosList.length === 0) {
                    // Add default custom scenarios
                    addCustomScenario(100, 50, 'Half Pot');
                    addCustomScenario(100, 100, 'Full Pot');
                    addCustomScenario(100, 150, '1.5x Pot');
                }
            } else {
                customSection.style.display = 'none';
            }
        });
        
        function addCustomScenario(pot, bet, name) {
            // If called with parameters, use them; otherwise get from inputs
            if (pot === undefined) {
                pot = parseInt(document.getElementById('customPot').value);
                bet = parseInt(document.getElementById('customBet').value);
                name = document.getElementById('customName').value || 'Custom';
            }
            
            // Validation
            if (bet > pot * 10) {
                alert('Bet size cannot be more than 10x the pot size');
                return;
            }
            
            if (customScenariosList.length >= 8) {
                alert('Maximum 8 custom scenarios allowed');
                return;
            }
            
            // Add to list
            customScenariosList.push({ pot, bet, name });
            updateCustomScenarioDisplay();
            
            // Clear inputs
            document.getElementById('customName').value = 'Custom';
        }
        
        function removeCustomScenario(index) {
            customScenariosList.splice(index, 1);
            updateCustomScenarioDisplay();
        }
        
        function updateCustomScenarioDisplay() {
            const listDiv = document.getElementById('customScenarioList');
            if (customScenariosList.length === 0) {
                listDiv.innerHTML = '<p style="color: #888; text-align: center;">No custom scenarios added yet</p>';
                return;
            }
            
            listDiv.innerHTML = customScenariosList.map((scenario, index) => `
                <div class="scenario-item">
                    <span>${scenario.name}: ${scenario.bet} chips into ${scenario.pot} pot (${(scenario.bet/scenario.pot).toFixed(2)}x)</span>
                    <button class="remove-btn" onclick="removeCustomScenario(${index})">Remove</button>
                </div>
            `).join('');
        }
        
        function getScenarioParams() {
            const scenarioType = document.getElementById('scenarios').value;
            const baseParams = {
                conservative: [
                    { pot: 200, bet: 50, name: "Quarter Pot" },
                    { pot: 150, bet: 75, name: "Half Pot" },
                    { pot: 120, bet: 90, name: "3/4 Pot" }
                ],
                standard: [
                    { pot: 100, bet: 50, name: "Half Pot" },
                    { pot: 100, bet: 75, name: "3/4 Pot" },
                    { pot: 100, bet: 100, name: "Full Pot" },
                    { pot: 100, bet: 150, name: "1.5x Pot" }
                ],
                aggressive: [
                    { pot: 100, bet: 100, name: "Full Pot" },
                    { pot: 100, bet: 150, name: "1.5x Pot" },
                    { pot: 100, bet: 200, name: "2x Pot" },
                    { pot: 100, bet: 300, name: "3x Pot" }
                ],
                extreme: [
                    { pot: 100, bet: 200, name: "2x Pot" },
                    { pot: 100, bet: 300, name: "3x Pot" },
                    { pot: 100, bet: 400, name: "4x Pot" },
                    { pot: 100, bet: 500, name: "5x Pot" }
                ],
                custom: customScenariosList
            };
            
            return baseParams[scenarioType];
        }

        function simulatePoker(potSize, betSize, numSimulations, callFreq, valueFreq) {
            const weakFreq = 1 - valueFreq;
            
            // Theoretical calculations
            const optimalBluffFreq = betSize / (potSize + betSize);
            const theoreticalBluffToValueRatio = betSize / potSize;
            
            // Calculate achievable bluffing frequency given constraints
            const maxBluffHands = weakFreq; // Can't bluff more than weak hands available
            const valueHands = valueFreq;
            const requiredBluffHands = valueHands * theoreticalBluffToValueRatio;
            const bluffProbability = Math.min(requiredBluffHands / weakFreq, 1.0);
            const achievableBluffFreq = Math.min(optimalBluffFreq, (bluffProbability * weakFreq) / (valueFreq + bluffProbability * weakFreq));
            
            // Simulation counters
            let totalBets = 0;
            let valueBets = 0;
            let bluffs = 0;
            let valueBetCalled = 0;
            let valueBetFolded = 0;
            let bluffCalled = 0;
            let bluffFolded = 0;
            let weakHandChecked = 0;
            
            let bettorEV = 0;
            let opponentEV = 0;
            let opponentCallEV = 0;
            let opponentCallCount = 0;
            
            for (let i = 0; i < numSimulations; i++) {
                const isValueHand = Math.random() < valueFreq;
                let handEV = 0;
                let opponentHandEV = 0;
                
                if (isValueHand) {
                    // Always bet value hands
                    totalBets++;
                    valueBets++;
                    
                    if (Math.random() < callFreq / 100) {
                        // Opponent calls - bettor wins pot + bet
                        valueBetCalled++;
                        handEV = potSize + betSize;
                        opponentHandEV = -betSize;
                        opponentCallEV += -betSize;
                        opponentCallCount++;
                    } else {
                        // Opponent folds - bettor wins pot
                        valueBetFolded++;
                        handEV = potSize;
                        opponentHandEV = 0;
                    }
                } else {
                    // Weak hand - decide whether to bluff
                    if (Math.random() < bluffProbability) {
                        // Bluff
                        totalBets++;
                        bluffs++;
                        
                        if (Math.random() < callFreq / 100) {
                            // Opponent calls - bettor loses bet, opponent wins pot
                            bluffCalled++;
                            handEV = -betSize;
                            opponentHandEV = potSize;
                            opponentCallEV += potSize;
                            opponentCallCount++;
                        } else {
                            // Opponent folds - bettor wins pot
                            bluffFolded++;
                            handEV = potSize;
                            opponentHandEV = 0;
                        }
                    } else {
                        // Check weak hand - go to showdown
                        weakHandChecked++;
                        // Assume opponent wins when we check weak hands
                        handEV = 0;
                        opponentHandEV = potSize;
                    }
                }
                
                bettorEV += handEV;
                opponentEV += opponentHandEV;
            }
            
            // Calculate averages
            const avgBettorEV = bettorEV / numSimulations;
            const avgOpponentEV = opponentEV / numSimulations;
            const avgOpponentCallEV = opponentCallCount > 0 ? opponentCallEV / opponentCallCount : 0;
            
            const actualBluffFreq = totalBets > 0 ? bluffs / totalBets : 0;
            const actualBluffToValueRatio = valueBets > 0 ? bluffs / valueBets : 0;
            
            return {
                // Parameters
                potSize,
                betSize,
                numSimulations,
                callFreq,
                valueFreq,
                
                // Theoretical
                optimalBluffFreq,
                achievableBluffFreq,
                theoreticalBluffToValueRatio,
                bluffProbability,
                
                // Simulation results
                totalBets,
                valueBets,
                bluffs,
                actualBluffFreq,
                actualBluffToValueRatio,
                
                // Scenario breakdown
                valueBetCalled,
                valueBetFolded,
                bluffCalled,
                bluffFolded,
                weakHandChecked,
                
                // Expected values
                avgBettorEV,
                avgOpponentEV,
                avgOpponentCallEV,
                
                // Validation
                theoreticalOpponentCallEV: 0, // By definition of optimal strategy
                constraintViolation: bluffProbability >= 1.0
            };
        }

        function formatNumber(num, decimals = 2) {
            return typeof num === 'number' ? num.toFixed(decimals) : num;
        }

        function formatPercentage(num) {
            return `${(num * 100).toFixed(1)}%`;
        }

        function formatRatio(decimal) {
            // Convert decimal to fraction
            if (decimal === 0) return "0 : 1";
            if (decimal === 1) return "1 : 1";
            
            // Find the closest simple fraction
            const tolerance = 0.01;
            const maxDenominator = 20;
            
            let bestNumerator = 1;
            let bestDenominator = 1;
            let bestError = Math.abs(decimal - 1);
            
            for (let denominator = 1; denominator <= maxDenominator; denominator++) {
                let numerator = Math.round(decimal * denominator);
                let error = Math.abs(decimal - numerator / denominator);
                
                if (error < bestError) {
                    bestError = error;
                    bestNumerator = numerator;
                    bestDenominator = denominator;
                    
                    if (error < tolerance) break;
                }
            }
            
            // Simplify fraction if possible
            const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
            const divisor = gcd(bestNumerator, bestDenominator);
            bestNumerator /= divisor;
            bestDenominator /= divisor;
            
            return `${bestNumerator} : ${bestDenominator}`;
        }

        function getStatusClass(callEV) {
            const absEV = Math.abs(callEV);
            if (absEV < 1) return 'success';
            if (absEV < 5) return 'warning';
            return 'error';
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            let html = '';
            
            // Add quick summary at the top
            html += `
                <div class="theory-section" style="background: rgba(0, 255, 136, 0.05); border: 1px solid #00ff88;">
                    <h3 style="color: #00ff88; margin-bottom: 15px;">📈 Quick Summary</h3>
                    <div class="theory-grid">
                        <div class="theory-card" style="background: rgba(0, 0, 0, 0.3);">
                            <h4>Simulation Parameters</h4>
                            <ul style="list-style: none; padding: 0;">
                                <li>• Simulations: ${results[0].numSimulations.toLocaleString()}</li>
                                <li>• Opponent Call Freq: ${results[0].callFreq}%</li>
                                <li>• Value Hand Freq: ${formatPercentage(results[0].valueFreq)}</li>
                                <li>• Weak Hand Freq: ${formatPercentage(1 - results[0].valueFreq)}</li>
                                <li>• Scenarios Tested: ${results.length}</li>
                            </ul>
                        </div>
                        <div class="theory-card" style="background: rgba(0, 0, 0, 0.3);">
                            <h4>Key Findings</h4>
                            <ul style="list-style: none; padding: 0;">
                                <li>• Best EV Scenario: ${results.reduce((best, r) => r.avgBettorEV > best.avgBettorEV ? r : best).scenarioName}</li>
                                <li>• Constraint Violations: ${results.filter(r => r.constraintViolation).length}</li>
                                <li>• Perfect Equilibrium: ${results.filter(r => Math.abs(r.avgOpponentCallEV) < 1).length}</li>
                                <li>• EV Range: ${formatNumber(Math.min(...results.map(r => r.avgBettorEV)))} to ${formatNumber(Math.max(...results.map(r => r.avgBettorEV)))} chips</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            results.forEach((result, index) => {
                const betRatio = result.betSize / result.potSize;
                const constraintStatus = result.constraintViolation ? 'error' : 'success';
                const equilibriumStatus = getStatusClass(result.avgOpponentCallEV);
                
                html += `
                    <div class="scenario">
                        <h3>${result.scenarioName} - ${result.betSize} chips into ${result.potSize} chip pot (${betRatio.toFixed(2)}x pot)</h3>
                        
                        <div class="metrics">
                            <div class="metric">
                                <div class="metric-label">Optimal Bluffing Frequency</div>
                                <div class="metric-value">${formatPercentage(result.optimalBluffFreq)}</div>
                            </div>
                            
                            <div class="metric">
                                <div class="metric-label">Achievable Bluffing Frequency</div>
                                <div class="metric-value">${formatPercentage(result.achievableBluffFreq)}</div>
                            </div>
                            
                            <div class="metric">
                                <div class="metric-label">Actual Bluffing Frequency</div>
                                <div class="metric-value">${formatPercentage(result.actualBluffFreq)}</div>
                            </div>
                            
                            <div class="metric">
                                <div class="metric-label">Bluff-to-Value Ratio</div>
                                <div class="metric-value">${formatRatio(result.actualBluffToValueRatio)}</div>
                            </div>
                            
                            <div class="metric">
                                <div class="metric-label">Bettor's Average EV</div>
                                <div class="metric-value">${formatNumber(result.avgBettorEV)} chips</div>
                            </div>
                            
                            <div class="metric">
                                <div class="metric-label">Opponent's Call EV</div>
                                <div class="metric-value">
                                    ${formatNumber(result.avgOpponentCallEV)} chips
                                    <span class="status ${equilibriumStatus}">
                                        ${Math.abs(result.avgOpponentCallEV) < 1 ? 'Equilibrium' : 'Off Balance'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="breakdown">
                            <h4>Hand Breakdown (${result.numSimulations.toLocaleString()} simulations)</h4>
                            <div class="breakdown-item">
                                <span>Value Bet Called:</span>
                                <span>${result.valueBetCalled.toLocaleString()} (${formatPercentage(result.valueBetCalled / result.numSimulations)})</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Value Bet Folded:</span>
                                <span>${result.valueBetFolded.toLocaleString()} (${formatPercentage(result.valueBetFolded / result.numSimulations)})</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Bluff Called:</span>
                                <span>${result.bluffCalled.toLocaleString()} (${formatPercentage(result.bluffCalled / result.numSimulations)})</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Bluff Folded:</span>
                                <span>${result.bluffFolded.toLocaleString()} (${formatPercentage(result.bluffFolded / result.numSimulations)})</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Weak Hand Checked:</span>
                                <span>${result.weakHandChecked.toLocaleString()} (${formatPercentage(result.weakHandChecked / result.numSimulations)})</span>
                            </div>
                        </div>
                        
                        ${result.constraintViolation ? `
                            <div class="breakdown" style="background: rgba(255, 68, 68, 0.1); border: 1px solid #ff4444;">
                                <h4 style="color: #ff4444;">⚠️ Mathematical Constraint Violation</h4>
                                <p>Required bluff probability: ${formatPercentage(result.bluffProbability)}</p>
                                <p>This bet size requires bluffing with more than 100% of weak hands!</p>
                                <p><strong>Strategy:</strong> Bet ALL weak hands as bluffs, but perfect equilibrium cannot be achieved.</p>
                                <p><strong>Implication:</strong> Your opponent can exploit you by calling more frequently.</p>
                            </div>
                        ` : ''}
                        
                        <div class="breakdown" style="margin-top: 15px; background: rgba(255, 170, 0, 0.05);">
                            <h4 style="color: #ffaa00;">💡 Strategic Insight</h4>
                            <p>${getStrategicInsight(result)}</p>
                        </div>
                    </div>
                `;
            });
            
            // Add comprehensive summary
            html += `
                <div class="summary">
                    <h3>📊 Comprehensive Analysis</h3>
                    <ul class="insights">
                        <li><strong>Value Hand Frequency:</strong> ${formatPercentage(results[0].valueFreq)} (${formatPercentage(1 - results[0].valueFreq)} weak hands available for bluffing)</li>
                        <li><strong>Optimal Strategy Formula:</strong> Bluff frequency = Bet Size / (Pot Size + Bet Size)</li>
                        <li><strong>Constraint Reality:</strong> ${results.filter(r => r.constraintViolation).length} of ${results.length} scenarios violate mathematical constraints</li>
                        <li><strong>Equilibrium Achievement:</strong> ${results.filter(r => Math.abs(r.avgOpponentCallEV) < 1).length} of ${results.length} scenarios achieve near-perfect equilibrium</li>
                        <li><strong>Bettor's Edge Range:</strong> ${formatNumber(Math.min(...results.map(r => r.avgBettorEV)))} to ${formatNumber(Math.max(...results.map(r => r.avgBettorEV)))} chips per hand</li>
                        <li><strong>Highest EV Scenario:</strong> ${results.reduce((best, r) => r.avgBettorEV > best.avgBettorEV ? r : best).scenarioName} with ${formatNumber(Math.max(...results.map(r => r.avgBettorEV)))} chips average EV</li>
                        <li><strong>Most Balanced Scenario:</strong> ${results.reduce((best, r) => Math.abs(r.avgOpponentCallEV) < Math.abs(best.avgOpponentCallEV) ? r : best).scenarioName} with opponent call EV of ${formatNumber(results.reduce((best, r) => Math.abs(r.avgOpponentCallEV) < Math.abs(best.avgOpponentCallEV) ? r : best).avgOpponentCallEV)} chips</li>
                    </ul>
                    
                    <h4 style="color: #ffaa00; margin-top: 25px;">🎯 Practical Recommendations</h4>
                    <ul class="insights">
                        ${getRecommendations(results)}
                    </ul>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        function getStrategicInsight(result) {
            const betRatio = result.betSize / result.potSize;
            const valueFreqPercent = result.valueFreq * 100;
            
            if (result.constraintViolation) {
                return `This extreme bet size (${betRatio.toFixed(1)}x pot) with ${valueFreqPercent}% value hands creates an unbalanced strategy. You need to bluff with more weak hands than you have available. You're forced to bluff with every weak hand, making you exploitable. Consider smaller bet sizes or adjusting your value hand frequency for better balance.`;
            } else if (Math.abs(result.avgOpponentCallEV) < 1) {
                return `This bet size achieves near-perfect equilibrium with ${valueFreqPercent}% value hands. Your opponent cannot gain an edge by adjusting their calling frequency. This is theoretically optimal play.`;
            } else if (result.avgOpponentCallEV > 5) {
                return `Your bluffing frequency is too low for this bet size. With ${valueFreqPercent}% value hands, you have ${(100 - valueFreqPercent)}% weak hands available for bluffing, but you're not bluffing enough. Your opponent profits by calling more often.`;
            } else if (result.avgOpponentCallEV < -5) {
                return `Your bluffing frequency is too high. Your opponent should fold more often. This might occur when constrained by having only ${(100 - valueFreqPercent)}% weak hands available for bluffing.`;
            } else {
                return `This scenario with ${valueFreqPercent}% value hands is close to equilibrium but slightly favors ${result.avgOpponentCallEV > 0 ? 'calling' : 'folding'}. Minor adjustments could achieve perfect balance.`;
            }
        }

        function getRecommendations(results) {
            const bestEV = results.reduce((best, r) => r.avgBettorEV > best.avgBettorEV ? r : best);
            const mostBalanced = results.reduce((best, r) => Math.abs(r.avgOpponentCallEV) < Math.abs(best.avgOpponentCallEV) ? r : best);
            const constraints = results.filter(r => r.constraintViolation).length;
            const valueFreqPercent = results[0].valueFreq * 100;
            
            let recommendations = [];
            
            if (constraints > results.length / 2) {
                recommendations.push(`<li><strong>Bet Sizing:</strong> With ${valueFreqPercent}% value hands, most scenarios violate constraints. Use conservative bet sizes (0.5x-1x pot) for balanced play, or increase your value hand frequency.</li>`);
            } else {
                recommendations.push(`<li><strong>Bet Sizing:</strong> With ${valueFreqPercent}% value hands, moderate bet sizes (0.75x-1.5x pot) provide good balance between EV and exploitability.</li>`);
            }
            
            if (valueFreqPercent < 30) {
                recommendations.push(`<li><strong>Value Hand Adjustment:</strong> Your low value frequency (${valueFreqPercent}%) gives you many bluffing opportunities but may make large bets unprofitable. Consider tightening your value range.</li>`);
            } else if (valueFreqPercent > 70) {
                recommendations.push(`<li><strong>Value Hand Adjustment:</strong> Your high value frequency (${valueFreqPercent}%) limits bluffing opportunities. You may struggle to balance larger bet sizes.</li>`);
            }
            
            recommendations.push(`<li><strong>Against Tight Players:</strong> The ${bestEV.scenarioName} scenario maximizes EV when opponents call ${bestEV.callFreq}% of the time.</li>`);
            
            recommendations.push(`<li><strong>For GTO Play:</strong> Use ${mostBalanced.scenarioName} for unexploitable strategy (opponent call EV: ${formatNumber(mostBalanced.avgOpponentCallEV)} chips).</li>`);
            
            if (results[0].callFreq > 70) {
                recommendations.push(`<li><strong>Adjustment:</strong> Against tight opponents (${results[0].callFreq}% call), increase bluff frequency slightly above theoretical optimal.</li>`);
            } else {
                recommendations.push(`<li><strong>Adjustment:</strong> Against loose opponents (${results[0].callFreq}% call), reduce bluffing and value bet more thinly.</li>`);
            }
            
            recommendations.push(`<li><strong>Real-World Application:</strong> Track opponent tendencies and adjust from theoretical optimal accordingly. Most players don't play perfect GTO.</li>`);
            
            return recommendations.join('');
        }

        async function runSimulation() {
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            
            // Switch to results tab
            showTab('results');
            document.querySelector('.tab:nth-child(3)').classList.add('active');
            document.querySelector('.tab:nth-child(2)').classList.remove('active');
            
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            const numSimulations = parseInt(document.getElementById('simulations').value);
            const callFreq = parseInt(document.getElementById('callFreq').value);
            const valueFreq = parseInt(document.getElementById('valueFreq').value) / 100;
            const scenarios = getScenarioParams();
            
            if (scenarios.length === 0) {
                alert('Please add at least one custom scenario');
                loadingDiv.style.display = 'none';
                return;
            }
            
            const results = [];
            
            for (let i = 0; i < scenarios.length; i++) {
                const scenario = scenarios[i];
                const result = simulatePoker(scenario.pot, scenario.bet, numSimulations, callFreq, valueFreq);
                result.scenarioName = scenario.name;
                results.push(result);
                
                // Small delay to prevent UI blocking
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            loadingDiv.style.display = 'none';
            displayResults(results);
        }

        // Initialize on load
        window.onload = () => {
            updateCustomScenarioDisplay();
        };
    </script>
</body>
</html>
